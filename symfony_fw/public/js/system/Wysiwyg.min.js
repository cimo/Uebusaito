"use strict";class Wysiwyg{constructor(){this.containerTag="",this.iframeBody=null,this.iframeContent=null,this.history=[],this.historyPosition=-1,this.historyLimit=300,this.historyRestore=!1}create=(t,e)=>{let i=setTimeout(()=>{clearTimeout(i),this.containerTag=t,$(this.containerTag).parent().css("margin","0"),$(this.containerTag).parent().hide(),$(e).click(()=>{this.fillField("source")}),this.iframe()},100)};historyClear=()=>{this.history=[]};save=()=>{this.fillField("source")};iframe=()=>{$(".wysiwyg").length>0&&($(".wysiwyg").find(".editor").contents().find("head").append("<style>\n                    html {\n                        padding: 5px !important;\n                        height: auto !important;\n                    }\n                    body div {\n                        margin: 0;\n                        min-height: 19px;\n                    }\n                    body .mdc-layout-grid {\n                        padding: 0;\n                    }\n                    body .mdc-layout-grid .mdc-layout-grid__cell {\n                        border: 1px solid #000000;\n                    }\n                </style>"),$($(".wysiwyg").find(".editor").contents().find("head")[0]).append($("<link/>",{rel:"stylesheet",href:`${window.url.root}/css/library/Roboto+Mono_custom.css`,type:"text/css"})),$($(".wysiwyg").find(".editor").contents().find("head")[0]).append($("<link/>",{rel:"stylesheet",href:`${window.url.root}/css/library/Roboto_300_400_500_custom.css`,type:"text/css"})),$($(".wysiwyg").find(".editor").contents().find("head")[0]).append($("<link/>",{rel:"stylesheet",href:`${window.url.root}/css/library/material-icons_custom.css`,type:"text/css"})),$($(".wysiwyg").find(".editor").contents().find("head")[0]).append($("<link/>",{rel:"stylesheet",href:`${window.url.root}/css/library/material-components-web_custom.min.css`,type:"text/css"})),$($(".wysiwyg").find(".editor").contents().find("head")[0]).append($("<link/>",{rel:"stylesheet",href:`${window.url.root}/css/system/" + window.setting.template + ".css`,type:"text/css"})),this.iframeBody=$(".wysiwyg").find(".editor").contents().find("body")[0],this.iframeContent=$(".wysiwyg").find(".editor").contents()[0],$(this.iframeBody).addClass("mdc-typography"),$(this.iframeBody).prop("contenteditable","true"),$(this.iframeBody).off("click").on("click","a",t=>{t.preventDefault()}),this.iframeContent.execCommand("defaultParagraphSeparator",!1,"div"),this.fillField("load"),this.toolbarEvent(),this.editorEvent())};fillField=t=>{if("load"===t)$(this.iframeBody).length>0&&($(this.iframeBody).html($(this.containerTag).val()),$(".wysiwyg").find(".source").text($(this.containerTag).val()),this.historyLoad($(this.containerTag).val()));else if("source"===t){if($(this.iframeBody).length>0){let t=$.trim($(this.iframeBody).html());$(this.containerTag).val(t),$(".wysiwyg").find(".source").text(t)}}else if("editor"===t){let t=$(".wysiwyg").find(".source");t.length>0&&$(this.iframeBody).html(t.text())}};toolbarEvent=()=>{$(".wysiwyg").find(".toolbar .mdc-fab").off("click").on("click","",t=>{t.preventDefault();let e=!0===$(t.target).parent().hasClass("mdc-fab")?$(t.target).parent():$(t.target),i=e.find("span").data("command");"source"===i?this.source():"foreColor"===i||"backColor"===i?this.executeCommand(i,e.next().val()):this.executeCommand(i)}),$(".wysiwyg").find(".mdc-select .mdc-select__native-control").off("change").on("change","",t=>{t.preventDefault();let e=$(t.target).data("command");"formatBlock"!==e&&"fontSize"!==e||this.executeCommand(e,$(t.target).val())})};source=()=>{!0===("none"===$(".wysiwyg").find(".source").css("display"))?(this.fillField("source"),$(".wysiwyg").find(".editor").hide(),$(".wysiwyg").find(".source").show()):(this.fillField("editor"),$(".wysiwyg").find(".source").hide(),$(".wysiwyg").find(".editor").show())};executeCommand=(t,e)=>{"undo"===t?this.historyUndo():"redo"===t?this.historyRedo():"foreColor"===t||"backColor"===t||"unlink"===t||"formatBlock"===t||"fontSize"===t?(this.iframeContent.execCommand(t,!1,e),this.historySave()):"createLink"===t?popupEasy.create(window.textWysiwyg.label_5,`<div id="wysiwyg_popup">\n                    <div class="mdc-text-field mdc-text-field__basic mdc-text-field--dense" style="width: 100%;">\n                        <input class="mdc-text-field__input" type="text" value="" autocomplete="off" aria-label="label"/>\n                        <label class="mdc-floating-label">${window.textWysiwyg.label_6}</label>\n                        <div class="mdc-line-ripple"></div>\n                    </div>\n                    <p class="mdc-text-field-helper-text" aria-hidden="true"></p>\n                </div>`,()=>{let e=$("#wysiwyg_popup").find(".mdc-text-field__input").val();this.iframeContent.execCommand(t,!1,e),this.historySave()}):"insertImage"===t?popupEasy.create(window.textWysiwyg.label_7,`<div id="wysiwyg_popup">\n                    <div class="mdc-text-field mdc-text-field__basic mdc-text-field--dense" style="width: 100%;">\n                        <input class="mdc-text-field__input" type="text" value="" autocomplete="off" aria-label="label"/>\n                        <label class="mdc-floating-label">${window.textWysiwyg.label_8}</label>\n                        <div class="mdc-line-ripple"></div>\n                    </div>\n                    <p class="mdc-text-field-helper-text" aria-hidden="true"></p>\n                </div>`,()=>{let e=$("#wysiwyg_popup").find(".mdc-text-field__input").val();this.iframeContent.execCommand(t,!1,e),this.historySave()}):"custom_button_add"===t?popupEasy.create(window.textWysiwyg.label_9,`<div id="wysiwyg_popup">\n                    <div class="mdc-text-field mdc-text-field__basic mdc-text-field--dense" style="width: 100%;">\n                        <input class="mdc-text-field__input label" type="text" value="" autocomplete="off" aria-label="label"/>\n                        <label class="mdc-floating-label">${window.textWysiwyg.label_10}</label>\n                        <div class="mdc-line-ripple"></div>\n                    </div>\n                    <p class="mdc-text-field-helper-text" aria-hidden="true"></p>\n                    <div class="mdc-text-field mdc-text-field__basic mdc-text-field--dense" style="width: 100%;">\n                        <input class="mdc-text-field__input link" type="text" value="" autocomplete="off" aria-label="label"/>\n                        <label class="mdc-floating-label">${window.textWysiwyg.label_11}</label>\n                        <div class="mdc-line-ripple"></div>\n                    </div>\n                    <p class="mdc-text-field-helper-text" aria-hidden="true"></p>\n                </div>`,()=>{let t=$("#wysiwyg_popup").find(".mdc-text-field__input.label").val(),e=$("#wysiwyg_popup").find(".mdc-text-field__input.link").val(),i="";i=""===e?`<button class="mdc-button mdc-button--dense mdc-button--raised" type="button" contenteditable="false" style="display: block;">${t}</button>`:`<a class="mdc-button mdc-button--dense mdc-button--raised" href="${e}" type="button" contenteditable="false">${t}</a>`,this.addHtmlAtCaretPosition(i),this.historySave()}):"custom_table_add"===t?popupEasy.create(window.textWysiwyg.label_12,`<div id="wysiwyg_popup">\n                    <div class="mdc-text-field mdc-text-field__basic mdc-text-field--dense" style="width: 100%;">\n                        <input class="mdc-text-field__input row_number" type="text" value="1" autocomplete="off" aria-label="label"/>\n                        <label class="mdc-floating-label">${window.textWysiwyg.label_13}</label>\n                        <div class="mdc-line-ripple"></div>\n                    </div>\n                    <p class="mdc-text-field-helper-text" aria-hidden="true"></p>\n                    <div class="mdc-text-field mdc-text-field__basic mdc-text-field--dense" style="width: 100%;">\n                        <input class="mdc-text-field__input column_number" type="text" value="4" autocomplete="off" aria-label="label"/>\n                        <label class="mdc-floating-label">${window.textWysiwyg.label_14}</label>\n                        <div class="mdc-line-ripple"></div>\n                    </div>\n                    <p class="mdc-text-field-helper-text" aria-hidden="true"></p>\n                </div>`,()=>{let t=$("#wysiwyg_popup").find(".row_number").val(),e=$("#wysiwyg_popup").find(".column_number").val(),i='<div class="mdc-layout-grid" contenteditable="false">';for(let l=0;l<t;l++){i+='<div class="mdc-layout-grid__inner" contenteditable="false">';for(let t=0;t<e;t++)i+='<div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-2" contenteditable="false">&nbsp;</div>';i+="</div>"}i+="</div>",this.addHtmlAtCaretPosition(i),this.historySave()}):(this.iframeContent.execCommand(t,!1,null),this.historySave())};historyUndo=()=>{if(this.historyPosition>=0){let t=this.history[--this.historyPosition];this.historyPosition<0&&(this.historyPosition=0,t=this.history[this.historyPosition]),$(this.iframeBody).html(t),this.historyRestore=!0}};historyRedo=()=>{if(this.historyPosition<this.history.length-1){let t=this.history[++this.historyPosition];$(this.iframeBody).html(t),this.historyRestore=!0}};historySave=()=>{this.spaceAfterElement(),this.removeDoubleSpace();let t=$(this.iframeBody).html();t!==this.history[this.historyPosition]&&(this.historyPosition<this.history.length-1&&this.history.splice(this.historyPosition+1),this.history.push(t),this.historyPosition++,this.historyPosition>this.historyLimit&&this.history.shift())};historyLoad=t=>{this.history.push(t),this.historyPosition=0};editorEvent=()=>{$(this.iframeBody).on("click","",t=>{this.historyRestore=!1;let e=this.findElementAtCaretPosition();!1===$(e).hasClass("mdc-layout-grid__cell")&&0===$(e).parents(".mdc-layout-grid__cell").length&&$(this.iframeBody).find(".mdc-layout-grid__cell").prop("contenteditable",!1)}),$(this.iframeBody).on("dblclick","",t=>{this.historyRestore=!1;let e=this.findElementAtCaretPosition();$(e).parents(".mdc-layout-grid__cell").length>0&&(e=$(e).parents(".mdc-layout-grid__cell")[0]),!0===$(e).hasClass("mdc-layout-grid__cell")&&($(this.iframeBody).find(".mdc-layout-grid__cell").prop("contenteditable",!1),$(e).prop("contenteditable",!0),$(e).focus())}),$(this.iframeBody).on("keydown","",t=>{if(t.ctrlKey||!0===t.metaKey){if(t.shiftKey&&90===t.keyCode)return this.historyRedo(),!1;if(90===t.keyCode)return this.historyUndo(),!1}}),$(this.iframeBody).on("keyup","",t=>{this.historySave()}),$(this.iframeBody).contextmenu(t=>{let e="",i=null,l="";if(!0===$(t.target).hasClass("mdc-button")){if(e="button",i=$(t.target),!0===$(t.target).is("button")){l=`<div class="mdc-text-field mdc-text-field__basic mdc-text-field--dense" style="width: 100%;">\n                        <input class="mdc-text-field__input label" type="text" value="${$(t.target).text()}" autocomplete="off" aria-label="label"/>\n                        <label class="mdc-floating-label">${window.textWysiwyg.label_10}</label>\n                        <div class="mdc-line-ripple"></div>\n                    </div>\n                    <p class="mdc-text-field-helper-text" aria-hidden="true"></p>`}else if(!0===$(t.target).is("a")){l=`<div class="mdc-text-field mdc-text-field__basic mdc-text-field--dense" style="width: 100%;">\n                        <input class="mdc-text-field__input label" type="text" value="${$(t.target).text()}" autocomplete="off" aria-label="label"/>\n                        <label class="mdc-floating-label">{window.textWysiwyg.label_10}</label>\n                        <div class="mdc-line-ripple"></div>\n                    </div>\n                    <p class="mdc-text-field-helper-text" aria-hidden="true"></p>\n                    <div class="mdc-text-field mdc-text-field__basic mdc-text-field--dense" style="width: 100%;">\n                        <input class="mdc-text-field__input link" type="text" value="${void 0===$(t.target).prop("href")?"":$(t.target).prop("href")}" autocomplete="off" aria-label="label"/>\n                        <label class="mdc-floating-label">${window.textWysiwyg.label_11}</label>\n                        <div class="mdc-line-ripple"></div>\n                    </div>\n                    <p class="mdc-text-field-helper-text" aria-hidden="true"></p>`}}else(!0===$(t.target).hasClass("mdc-layout-grid__cell")||$(t.target).parents(".mdc-layout-grid__cell").length>0)&&(i=$(t.target),$(t.target).parents(".mdc-layout-grid__cell").length>0&&(i=$(t.target).parents(".mdc-layout-grid__cell")),e="table",l=`<fieldset>\n                    <legend>${window.textWysiwyg.label_16}</legend>\n                    <button id="row_add" class="mdc-button mdc-button--dense mdc-button--raised" type="button">${window.textWysiwyg.label_17}</button>\n                    <button id="row_remove" class="mdc-button mdc-button--dense mdc-button--raised" type="button">${window.textWysiwyg.label_18}</button>\n                </fieldset>\n                <fieldset>\n                    <legend>${window.textWysiwyg.label_19}</legend>\n                    <button id="column_add" class="mdc-button mdc-button--dense mdc-button--raised" type="button">${window.textWysiwyg.label_20}</button>\n                    <button id="column_remove" class="mdc-button mdc-button--dense mdc-button--raised" type="button">${window.textWysiwyg.label_21}</button>\n                </fieldset>`);return""!==l&&this.popupsetting(e,i,l),!1})};popupsetting=(t,e,i)=>{popupEasy.create(window.textWysiwyg.label_15,`<div id="wysiwyg_popup">${i}</div>`,()=>{if("button"===t){let t=$("#wysiwyg_popup").find(".mdc-text-field__input.label").val(),i=$("#wysiwyg_popup").find(".mdc-text-field__input.link").val();e.text(t),e.prop("href",i)}this.historySave()}),"table"===t&&($("#row_add").off("click").on("click","",t=>{let i=e.parent().find(".mdc-layout-grid__cell").length,l='<div class="mdc-layout-grid__inner" contenteditable="false">';for(let t=0;t<i;t++)l+='<div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-2" contenteditable="false">&nbsp;</div>';l+="</div>",e.parent().after(l),popupEasy.close(),this.historySave()}),$("#row_remove").off("click").on("click","",t=>{e.parent().remove(),popupEasy.close(),this.historySave()}),$("#column_add").off("click").on("click","",t=>{let i=e.index();$.each(e.parents(".mdc-layout-grid").find(".mdc-layout-grid__inner"),(t,e)=>{$(e).find(".mdc-layout-grid__cell").eq(i).after('<div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-2" contenteditable="false">&nbsp;</div>')}),popupEasy.close(),this.historySave()}),$("#column_remove").off("click").on("click","",t=>{let i=e.index();$.each(e.parents(".mdc-layout-grid").find(".mdc-layout-grid__inner"),(t,l)=>{if(1===$(l).find(".mdc-layout-grid__cell").length)return e.parents(".mdc-layout-grid").remove(),!1;$(l).find(".mdc-layout-grid__cell").eq(i).remove()}),popupEasy.close(),this.historySave()}))};findElementAtCaretPosition=()=>{let t=window.frames[0].document,e=null,i=null;return t.getSelection()?(e=t.getSelection(),i=e.anchorNode):t.selection&&(e=t.selection,i=e.anchorNode),null!==i&&(i=3===i.nodeType?i.parentNode:i),i};addHtmlAtCaretPosition=t=>{let e=window.frames[0].document,i=null;if(e.getSelection()){if(selection=e.getSelection(),selection.getRangeAt()&&selection.rangeCount()){let e=window.frames[0].document.createElement("div");e.innerHTML=t;let l=window.frames[0].document.createDocumentFragment(),s=null;for(;node=e.firstChild;)s=l.appendChild(node);i=selection.getRangeAt(0),i.deleteContents(),i.insertNode(l),s&&(i=i.cloneRange(),i.setStartAfter(s),i.collapse(!0),selection.removeAllRanges(),selection.addRange(i))}}else e.selection&&(selection=e.selection,"Control"!==selection.type&&(i=selection.createRange(),i.pasteHTML(t)))};spaceAfterElement=()=>{let t=$(this.iframeContent).find(".mdc-button, .mdc-layout-grid");$.each(t,(t,e)=>{0===$(e).prev("br").length&&$(e).before("<br>"),0===$(e).next("br").length&&$(e).after("<br>")})};removeDoubleSpace=()=>{let t=$(this.iframeContent).find("br");$.each(t,(t,e)=>{1===$(e).prev("br").length&&$(e).prev("br").remove(),1===$(e).next("br").length&&$(e).next("br").remove()})}}